import numpy as np
import matplotlib.pyplot as plt
from matplotlib.animation import FuncAnimation
from mpl_toolkits.mplot3d import Axes3D

# 함수 정의
def f(x, y):
    return (x**2 - 2)**2 + (y**2 - 2)**2

def grad_f(x, y):
    dfdx = 4 * x * (x**2 - 2)
    dfdy = 4 * y * (y**2 - 2)
    return np.array([dfdx, dfdy])

# SGD Optimizer
def sgd(start, lr=0.01, steps=100):
    x = start.copy()
    path = [x.copy()]
    for _ in range(steps):
        g = grad_f(*x)
        x -= lr * g
        path.append(x.copy())
    return np.array(path)

# Momentum Optimizer
def momentum_sgd(start, lr=0.01, steps=100, momentum=0.9):
    x = start.copy()
    v = np.zeros_like(x)
    path = [x.copy()]
    for _ in range(steps):
        g = grad_f(*x)
        v = momentum * v - lr * g
        x += v
        path.append(x.copy())
    return np.array(path)

# 실제 공 (뉴턴역학): 위치, 속도 업데이트
def physics_ball(start, steps=100, dt=0.1, friction=0.1, mass=1.0):
    x = start.copy()
    v = np.zeros_like(x)
    path = [x.copy()]
    for _ in range(steps):
        F = -grad_f(*x)
        a = F / mass
        v += a * dt
        v *= (1 - friction)  # 마찰
        x += v * dt
        path.append(x.copy())
    return np.array(path)

# 경로 계산
start = np.array([2.5, 2.5])
sgd_path = sgd(start, lr=0.01, steps=100)
momentum_path = momentum_sgd(start, lr=0.01, steps=100, momentum=0.9)
ball_path = physics_ball(start, steps=100, dt=0.1, friction=0.1)

# 애니메이션 설정
fig = plt.figure(figsize=(10, 8))
ax = fig.add_subplot(111, projection='3d')
X = Y = np.linspace(-3, 3, 100)
X, Y = np.meshgrid(X, Y)
Z = f(X, Y)
ax.plot_surface(X, Y, Z, alpha=0.3, cmap='viridis', edgecolor='none')

sgd_line, = ax.plot([], [], [], 'r-', label='SGD')
momentum_line, = ax.plot([], [], [], 'b-', label='Momentum')
ball_line, = ax.plot([], [], [], 'g-', label='Ball (Physics)')
ax.legend()

def init():
    sgd_line.set_data([], [])
    sgd_line.set_3d_properties([])

    momentum_line.set_data([], [])
    momentum_line.set_3d_properties([])

    ball_line.set_data([], [])
    ball_line.set_3d_properties([])
    return sgd_line, momentum_line, ball_line

def update(i):
    for line, path in zip([sgd_line, momentum_line, ball_line], 
                          [sgd_path, momentum_path, ball_path]):
        line.set_data(path[:i+1, 0], path[:i+1, 1])
        z = [f(x, y) for x, y in path[:i+1]]
        line.set_3d_properties(z)
    return sgd_line, momentum_line, ball_line

ani = FuncAnimation(fig, update, frames=len(sgd_path), init_func=init,
                    blit=True, interval=100, repeat=False)

ax.set_xlabel("x")
ax.set_ylabel("y")
ax.set_zlabel("f(x, y)")
ax.set_title("SGD vs Momentum vs Physical Ball")

plt.show()
